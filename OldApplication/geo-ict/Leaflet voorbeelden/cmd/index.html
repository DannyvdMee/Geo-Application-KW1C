<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>GPS ondersteuning Cash Match Day KW1C</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="signin.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <style>
      .bad {
         background: red;
         color: white;
      }
      .good {
          background: green;
          color: white;
      }
      .reached {
          background: blue;
          color: white;
      }
      .bigger {
        font-size: 200%;
        font-weight: bold;
      }
  </style>
  </head>

  <body>
    <div class="container">
      <form class="form-signin" role="form">
        <h2 class="form-signin-heading">Volgende waypoint:</h2>
        <input type="text" name="waypoint" class="form-control" placeholder="Naam waypoint" required autofocus>
        <button class="btn btn-lg btn-primary btn-block btn-waypoint" type="button">Verzend</button>
      </form>
      <div class="waypoint-ongoing">
          <h2 class="waypoint-name"></h2>
          <div>
              <p>
                  Start met lopen; pas als je gaat lopen (minimaal > 5 meter) krijg je informatie of je de goeie kant opgaat. 
                  Als je op minder dan 10 meter van de waypoint bent mag je de volgende waypoint invoeren.
              </p>
          </div>
          <div class="waypoint-info">
          </div>
      </div>
      
      <div class="debug">
      </div>
      <div class="status"></div>
    </div> <!-- /container -->
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/RIFFWAVE.js"></script>


    <script>
        var waypoints = { ijzerenkind : {lat: '51.697192', lon: '5.335814' },
                          oosterplas  : {lat: '51.693227', lon: '5.343239'},
                          moorstraat  :  {lat: '51.695389', lon: '5.336569'},
                          thuis: {lat: '51.695855', lon: '5.336720'},
                          appie: {lat: '51.695908', lon: '5.329698'}
                        };

        var latWp = lonWp = null;
        var zoekWp = '';
        var scrStat = 0;
        var myInterval = null;
        var counter = 0;
        var prevDist = 0;
        var watcher = null;
        var audio = new Audio(); // create the HTML5 audio element

        if (typeof(Number.prototype.toRadians) === "undefined") {
          Number.prototype.toRadians = function() {
            return this * Math.PI / 180;
          }
        }

        function playSound(sts) {
            var wave = new RIFFWAVE(); // create an empty wave file
            var data = []; // yes, it's an array

            wave.header.numChannels = 1; // two channels (stereo)

            if (sts==0) {
              wave.header.sampleRate = 11025; // set sample rate to 44KHz
            }
            else {
              wave.header.sampleRate = 88200; // set sample rate to 44KHz
            }
            var i = 0;
            while (i< 10000) { 
              data[i++] = 128+Math.round(127*Math.sin(i/10)); // left speaker
              //data[i++] = 128+Math.round(127*Math.sin(i/200)); // right speaker
            }

            wave.Make(data); // make the wave file
            audio.src = wave.dataURI; // set audio source
            console.log(wave.dataURI);
            audio.play(); // we should hear two tones one on each speaker
        }

        function distance(lat1, lon1, lat2, lon2) {
            lat1 = lat1 *1;
            lon1 = lon1 *1;
            lat2 = lat2 *1;
            lon2 = lon2 *1;  
            var R = 6371000; // m
            var phi1 = lat1.toRadians();
            var phi2 = lat2.toRadians();
            var deltaphi = (lat2-lat1).toRadians();
            var deltalambda = (lon2-lon1).toRadians();

            var a = Math.sin(deltaphi/2) * Math.sin(deltaphi/2) +
                    Math.cos(phi1) * Math.cos(phi2) *
                    Math.sin(deltalambda/2) * Math.sin(deltalambda/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }

        function success(position) {

          var d = distance(latWp, lonWp, position.coords.latitude, position.coords.longitude);

          if (d < 20) {
               navigator.geolocation.clearWatch(watcher);
               $('.waypoint-ongoing').hide();
               $('.form-signin').slideDown();
               $('.container').removeClass('good').removeClass('bad').addClass('reached');
               $('.status').html('<h2>Waypoint bereikt!</h2>');
               setTimeout(function(){ $('.status').html(''); $('.container').removeClass('reached')},3000);
               scrStat = 0; zoekWp = null;
               return;
          }

          if (scrStat == 0) {
              $('.waypoint-ongoing').slideDown('slow');
              $('.form-signin').slideUp('slow');
              scrStat++;
          } else {
              //je loopt in de juiste richting
              if (d < prevDist) {
                $('.container').addClass('good').removeClass('bad');
              } else {
                $('.container').removeClass('good').addClass('bad');
              }

              //afstand is meer dan 2m groter geworden
              if (d - prevDist >= 3 ) {
                  playSound(1);
              }

              //afstand tot waypoint is meer dan 2m korter geworden
              if (prevDist - d >= 3 ) {
                  playSound(0);
              }


          }

          $('.waypoint-name').html(zoekWp);
          $('.waypoint-info').html('<p>Je bevindt je op <span class="bigger">'+ d + '</span>  m afstand (' + counter++ + ')' );

          //$('.debug').append('<br>' + position.coords.latitude + ' ' +position.coords.longitude );

          prevDist = d;
        }

 
        function error(msg) {
         
          alert (msg);
          // console.log(arguments); 
        }

        $(document).ready(function(){
            $('.waypoint-ongoing').hide();
            $('.btn-waypoint').click(function() {

              playSound(0);
              var wp = $('input[name=waypoint]').val();
              wp = wp.toLowerCase();
              if (wp == '') {
                  error('Vul een waypoint in');
              } 
              else {
                var gevonden = false;
                for (i in waypoints){
                    if (i == wp) {
                        latWp = waypoints[i].lat;
                        lonWp = waypoints[i].lon;
                        zoekWp = i;
                        gevonden = true;
                    }
                }
                if (gevonden) {
                  if (navigator.geolocation) {
                      watcher = navigator.geolocation.watchPosition(success, error,{enableHighAccuracy: true});
                  } else {
                      error(' geo location not supported');
                  } 
                }       
                else {
                    error ('waypoint bestaat niet, probeer nogmaals');
                }        
              }
            })
        });
    </script>
  </body>
</html>
